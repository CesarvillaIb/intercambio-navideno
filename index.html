<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Intercambio Navide√±o Familiar 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: radial-gradient(
        circle at top,
        #ffffff 0,
        #ffe6ec 25%,
        #5b0b12 70%,
        #050816 100%
      );
      color: #1f2933;
      overflow: hidden;
    }

    /* Nieve */
    .snow {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }
    .snow span {
      position: absolute;
      top: -10px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      animation: fall linear infinite;
      opacity: 0.8;
    }
    @keyframes fall {
      0% {
        transform: translateY(-10px);
      }
      100% {
        transform: translateY(110vh);
      }
    }

    .reindeer {
      position: fixed;
      bottom: 18px;
      left: -60px;
      font-size: 34px;
      z-index: 1;
      animation: walkReindeer 14s linear infinite;
      opacity: 0.9;
    }
    @keyframes walkReindeer {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(120vw);
      }
    }

    /* Tarjeta principal */
    .card {
      position: relative;
      z-index: 2;
      background: rgba(255, 255, 255, 0.96);
      border-radius: 24px;
      padding: 22px 18px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(248, 250, 252, 0.95);
      animation: cardIn 0.45s ease-out;
    }
    @keyframes cardIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -2px;
      border-radius: 26px;
      padding: 1px;
      background: linear-gradient(
        135deg,
        rgba(239, 68, 68, 0.7),
        rgba(34, 197, 94, 0.7)
      );
      -webkit-mask: linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.75;
      pointer-events: none;
    }

    .santa-mini {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 40px;
      z-index: 3;
      animation: danceSanta 1s infinite ease-in-out;
    }
    @keyframes danceSanta {
      0% {
        transform: translateX(-50%) rotate(-10deg);
      }
      50% {
        transform: translateX(-50%) rotate(10deg);
      }
      100% {
        transform: translateX(-50%) rotate(-10deg);
      }
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.85rem;
      padding: 5px 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, #b91c1c, #065f46);
      color: #fefce8;
      margin: 20px auto 12px;
    }

    h1 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 4px;
      color: #111827;
    }

    .tagline {
      font-size: 0.85rem;
      text-align: center;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .price {
      font-size: 0.95rem;
      text-align: center;
      font-weight: 600;
      margin-bottom: 10px;
      color: #b91c1c;
    }

    .place {
      font-size: 0.82rem;
      text-align: center;
      margin-bottom: 16px;
      color: #374151;
      line-height: 1.4;
    }
    .place a {
      color: #16a34a;
      font-weight: 600;
      text-decoration: none;
    }

    .subtitle {
      font-size: 0.9rem;
      text-align: center;
      color: #4b5563;
      margin-bottom: 14px;
    }

    label {
      font-size: 0.85rem;
      margin-bottom: 6px;
      color: #111827;
      display: block;
    }

    select,
    button {
      width: 100%;
      padding: 12px 14px;
      border-radius: 999px;
      font-size: 1rem;
      outline: none;
    }

    select {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      margin-bottom: 14px;
    }
    select:focus {
      border-color: #16a34a;
      box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.25);
    }

    button {
      background: linear-gradient(135deg, #b91c1c, #16a34a);
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    button:active {
      transform: scale(0.97);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
    }

    .result {
      display: none;
      margin-top: 18px;
      padding: 14px;
      border-radius: 14px;
      background: #f1f5f9;
      border: 1px dashed #9ca3af;
      font-size: 0.95rem;
      transform-origin: center;
      text-align: center;
    }
    .result.show {
      display: block;
      animation: resultPop 0.28s ease-out;
    }
    @keyframes resultPop {
      0% {
        opacity: 0;
        transform: scale(0.9) translateY(6px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .error {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #b91c1c;
      text-align: center;
    }

    .note {
      font-size: 0.8rem;
      margin-top: 12px;
      text-align: center;
      color: #6b7280;
    }

    .footer {
      font-size: 0.7rem;
      text-align: center;
      margin-top: 18px;
      color: #9ca3af;
    }

    .creator {
      font-size: 0.7rem;
      text-align: center;
      margin-top: 4px;
      color: #7f8c9d;
    }

    @media (max-width: 600px) {
      .card {
        padding: 18px 14px;
      }
      h1 {
        font-size: 1.4rem;
      }
    }

    /* ========= PANEL ADMIN ========= */

    .admin-panel {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 30;
      background: #020617;
      color: #e5e7eb;
      border-radius: 20px;
      padding: 14px 16px 14px 16px;
      width: 260px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
      font-size: 0.8rem;
    }

    .admin-panel h2 {
      margin: 0 0 4px 0;
      font-size: 0.95rem;
      text-align: left;
    }

    .admin-small {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .admin-btn {
      margin-top: 6px;
      margin-bottom: 10px;
      width: 100%;
      padding: 8px 10px;
      font-size: 0.8rem;
      border-radius: 999px;
      background: linear-gradient(135deg, #0369a1, #0ea5e9);
      box-shadow: 0 4px 12px rgba(15, 118, 178, 0.5);
      border: none;
      cursor: pointer;
      color: #e5e7eb;
    }

    .admin-section-title {
      font-weight: 600;
      margin-top: 4px;
      margin-bottom: 4px;
      font-size: 0.78rem;
      color: #e5e7eb;
    }

    .admin-list {
      max-height: 170px;
      overflow-y: auto;
      padding: 6px 8px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      margin-bottom: 4px;
    }

    .admin-list div {
      padding: 2px 0;
    }

    .admin-list-item-ok {
      color: #bbf7d0;
    }

    .admin-list-item-pend {
      color: #e5e7eb;
      opacity: 0.7;
    }
  </style>
</head>

<body>
  <div class="snow" id="snow"></div>
  <div class="reindeer">ü¶å</div>

  <div class="card">
    <div class="santa-mini">üéÖ</div>

    <div class="badge">Intercambio Navide√±o 2025</div>

    <h1>Santa Secreto Familiar</h1>
    <p class="tagline">Familia Villa ¬∑ Unidos ¬∑ Tradici√≥n ¬∑ Buenos momentos üéÅ</p>
    <p class="price">
      üí∞ Monto del intercambio: <strong>$500 MXN</strong>
    </p>

    <p class="place">
      üìç <strong>Casa de Sergio Villa</strong><br />
      Calle Guam√∫chil #52 ¬∑ Col. El Tizate ¬∑ Zapopan, Jalisco<br />
      üëâ
      <a
        href="https://maps.app.goo.gl/PkwVp3p2bp2CBwY8A"
        target="_blank"
        >Ver ubicaci√≥n en Google Maps</a
      >
    </p>

    <p class="subtitle">
      Selecciona tu nombre para saber a qui√©n le vas a regalar.
    </p>

    <label for="nameSelect">¬øQui√©n eres?</label>
    <select id="nameSelect">
      <option value="">-- Selecciona tu nombre --</option>
    </select>

    <button id="drawBtn">Ver a qui√©n le regalo üéÅ</button>

    <div id="result" class="result"></div>
    <div id="error" class="error"></div>

    <p class="note">
      üí° Solo ver√°s tu propio resultado.<br />
      No recargues la p√°gina para espiar, conf√≠a en la magia navide√±a üòú
    </p>
    <p id="deviceNote" class="note" style="display: none"></p>

    <div class="footer">Intercambio navide√±o familiar ¬∑ 2025</div>
    <div class="creator">
      Creado por <strong>Paulo Cesar Villa Ibarra</strong>
    </div>
  </div>

  <!-- ====================================================== -->
  <!--  L√ìGICA COMPLETA (SORTEO + FIREBASE + PANEL ADMIN)     -->
  <!-- ====================================================== -->
  <script type="module">
    /* ========= LISTA DE PARTICIPANTES ========= */
    const PARTICIPANTS = [
      "Paulo Cesar",
      "Naydelin Fernanda",
      "Sergio Villa",
      "Julia Ibarra",
      "Daniel Villa",
      "Oscar Padilla",
      "Mayra Villa",
      "Leonardo Mat√≠as",
      "Papa Chava",
      "Mama Tere",
      "Tania Villa",
      "Novio de Tania Diego",
      "Mayte Villa",
      "Marichuy",
      "Omar Junior",
      "Fernanda Qui√±ones",
      "Beto El que me regalara su carro",
      "Brayan",
      "Novia de Brayan Valentina",
      "Salvador Villa",
      "Irene Salazar"
    ];

    /* ========= RANDOM DETERMINISTA PARA EL SORTEO ========= */
    function xmur3(str) {
      let h = 1779033703 ^ str.length;
      for (let i = 0; i < str.length; i++) {
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      return function () {
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        h ^= h >>> 16;
        return h >>> 0;
      };
    }

    function mulberry32(a) {
      return function () {
        let t = a += 0x6d2b79f5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t = t ^ (t + Math.imul(t ^ (t >>> 7), t | 61));
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function seededShuffle(array, seedStr) {
      const seedFn = xmur3(seedStr);
      const rng = mulberry32(seedFn());
      const a = array.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function generateDerangement(names, seedStr, maxTries = 1000) {
      for (let attempt = 0; attempt < maxTries; attempt++) {
        const shuffled = seededShuffle(names, seedStr + "#" + attempt);
        let valid = true;
        for (let i = 0; i < names.length; i++) {
          if (names[i] === shuffled[i]) {
            valid = false;
            break;
          }
        }
        if (valid) return shuffled;
      }
      throw new Error("No se pudo generar un sorteo v√°lido. Revisa la lista de participantes.");
    }

    function buildAssignmentMap(names, seedStr) {
      const derangement = generateDerangement(names, seedStr);
      const map = {};
      names.forEach((name, idx) => {
        map[name] = derangement[idx];
      });
      return map;
    }

    /* ========= FIREBASE ========= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBkln8OvQIhSd2Phnbt0VpUWxwlfiP5upo",
      authDomain: "intercambio-familiar-2025.firebaseapp.com",
      projectId: "intercambio-familiar-2025",
      storageBucket: "intercambio-familiar-2025.firebasestorage.app",
      messagingSenderId: "782877002512",
      appId: "1:782877002512:web:fa9e0fc96fa2fe2074f395"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const edicionParam = params.get("edicion");
    const isAdmin = params.get("admin") === "paulo2025";

    const configRef = doc(db, "config", "general");

    async function getCurrentEdition() {
      // Si la URL trae ?edicion=, usamos esa (para revisar ediciones viejas)
      if (edicionParam) return edicionParam;

      // Si no trae, usamos la edici√≥n actual guardada en Firestore
      const snap = await getDoc(configRef);
      if (snap.exists() && snap.data().edicionActual) {
        return String(snap.data().edicionActual);
      }

      // Si no existe, creamos edicionActual = 1
      await setDoc(configRef, { edicionActual: 1 }, { merge: true });
      return "1";
    }

    async function crearNuevaEdicion(editionActual) {
      const actualNum = parseInt(editionActual, 10) || 1;
      const next = actualNum + 1;

      // Actualizamos edici√≥n actual en config
      await setDoc(configRef, { edicionActual: next }, { merge: true });

      // Preparamos documento de vistas para la nueva edici√≥n
      const newVistasRef = doc(db, "vistas", `edicion-${next}`);
      await setDoc(newVistasRef, { vistos: {} }, { merge: true });

      // Recargamos el link base CON admin, pero SIN edicion=
      const base = window.location.origin + window.location.pathname;
      window.location.href = `${base}?admin=paulo2025`;
    }

    function initSnow(container) {
      const flakes = 60;
      for (let i = 0; i < flakes; i++) {
        const span = document.createElement("span");
        const size = Math.random() * 6 + 3;
        span.style.left = Math.random() * 100 + "vw";
        span.style.width = size + "px";
        span.style.height = size + "px";
        span.style.animationDuration = Math.random() * 10 + 8 + "s";
        span.style.animationDelay = Math.random() * -20 + "s";
        container.appendChild(span);
      }
    }

    async function main() {
      const edition = await getCurrentEdition();
      const SEED = "intercambio-navideno-familiar-2025-edicion-" + edition;
      const STORAGE_KEY =
        "intercambio_navideno_2025_nombre_edicion_" + edition;

      const vistasRef = doc(db, "vistas", `edicion-${edition}`);
      const vistasSnap = await getDoc(vistasRef);
      if (!vistasSnap.exists()) {
        await setDoc(vistasRef, { vistos: {} }, { merge: true });
      }

      const nameSelect = document.getElementById("nameSelect");
      const drawBtn = document.getElementById("drawBtn");
      const resultBox = document.getElementById("result");
      const errorBox = document.getElementById("error");
      const deviceNote = document.getElementById("deviceNote");
      const snowContainer = document.getElementById("snow");

      initSnow(snowContainer);

      // Llenar select
      PARTICIPANTS.forEach((name) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        nameSelect.appendChild(opt);
      });

      // Asignaciones deterministas
      let assignment;
      try {
        assignment = buildAssignmentMap(PARTICIPANTS, SEED);
      } catch (err) {
        errorBox.textContent = err.message;
        drawBtn.disabled = true;
        return;
      }

      // Control de dispositivo
      let storedName = localStorage.getItem(STORAGE_KEY);
      if (storedName && PARTICIPANTS.includes(storedName)) {
        nameSelect.value = storedName;
        deviceNote.textContent =
          "üì± Este dispositivo est√° registrado para: " +
          storedName +
          " (Edici√≥n " +
          edition +
          ").";
        deviceNote.style.display = "block";
      }

      async function marcarComoVisto(nombre) {
        await updateDoc(vistasRef, {
          [`vistos.${nombre}`]: true
        });
        alert("Marcado como visto ‚úî");

        // refrescar panel admin si existe
        if (isAdmin) {
          const oldPanel = document.getElementById("adminPanel");
          if (oldPanel) oldPanel.remove();
          renderAdminPanel();
        }
      }

      drawBtn.addEventListener("click", () => {
        errorBox.textContent = "";
        resultBox.classList.remove("show");

        const selected = nameSelect.value;
        if (!selected) {
          errorBox.textContent = "Por favor, selecciona tu nombre.";
          resultBox.style.display = "none";
          return;
        }

        // Bloquear que se hagan pasar por otra persona (salvo admin)
        if (!isAdmin) {
          if (storedName && selected !== storedName) {
            errorBox.textContent =
              'Este dispositivo ya est√° asociado al nombre: "' +
              storedName +
              '". Solo puedes ver tu propio resultado.';
            resultBox.style.display = "none";
            return;
          }
          if (!storedName) {
            storedName = selected;
            localStorage.setItem(STORAGE_KEY, storedName);
            deviceNote.textContent =
              "üì± Este dispositivo est√° registrado para: " +
              storedName +
              " (Edici√≥n " +
              edition +
              ").";
            deviceNote.style.display = "block";
          }
        }

        const target = assignment[selected];
        if (!target) {
          errorBox.textContent = "Hubo un problema con el sorteo.";
          resultBox.style.display = "none";
          return;
        }

        resultBox.innerHTML = `
          üëã Hola, <strong>${selected}</strong><br/>
          Te toca regalarle a:<br/>
          üéÅ <strong>${target}</strong>
          <br/><br/>
          <button id="okBtn">Entendido ‚úî</button>
        `;
        resultBox.classList.add("show");

        const okBtn = document.getElementById("okBtn");
        okBtn.addEventListener("click", () => {
          marcarComoVisto(selected);
        });
      });

      async function renderAdminPanel() {
        if (!isAdmin) return;

        const snap = await getDoc(vistasRef);
        const data = snap.exists() ? snap.data() : {};
        const vistos = data.vistos || {};

        const total = PARTICIPANTS.length;
        const confirmados = PARTICIPANTS.filter((n) => vistos[n]).length;

        // Parejas solo de los que confirmaron
        const parejasConfirmadas = PARTICIPANTS.filter((n) => vistos[n]).map(
          (n) => `${n} ‚Üí ${assignment[n]}`
        );

        const panel = document.createElement("div");
        panel.id = "adminPanel";
        panel.className = "admin-panel";
        panel.innerHTML = `
          <h2>üëë Admin ‚Äì Edici√≥n ${edition}</h2>
          <div class="admin-small">Paulo Cesar<br />Este panel solo lo ves t√∫.</div>

          <button class="admin-btn" id="btnNuevaEdicion">‚ûï Crear nueva edici√≥n</button>

          <div class="admin-section-title">Confirmaciones (${confirmados} de ${total})</div>
          <div class="admin-list">
            ${PARTICIPANTS.map((n) => {
              const ok = !!vistos[n];
              const cls = ok ? "admin-list-item-ok" : "admin-list-item-pend";
              return `<div class="${cls}">${n}</div>`;
            }).join("")}
          </div>

          <div class="admin-section-title" style="margin-top: 6px;">Parejas confirmadas</div>
          <div class="admin-list">
            ${
              parejasConfirmadas.length
                ? parejasConfirmadas.map((p) => `<div>${p}</div>`).join("")
                : "<div class='admin-small'><i>Todav√≠a nadie ha confirmado su resultado.</i></div>"
            }
          </div>

          <div class="admin-small" style="margin-top: 6px;">
            ‚Ä¢ El link p√∫blico <strong>NO cambia</strong>:<br />
            ${window.location.origin + window.location.pathname}<br /><br />
            ‚Ä¢ Para entrar como admin usa:<br />
            ${window.location.origin + window.location.pathname}?admin=paulo2025
          </div>
        `;
        document.body.appendChild(panel);

        const btnNuevaEdicion = document.getElementById("btnNuevaEdicion");
        btnNuevaEdicion.addEventListener("click", () =>
          crearNuevaEdicion(edition)
        );
      }

      renderAdminPanel();
    }

    main();
  </script>
</body>
</html>
