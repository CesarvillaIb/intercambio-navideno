<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Intercambio Navide√±o Familiar 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: radial-gradient(circle at top, #ffffff 0, #ffe6ec 25%, #5b0b12 70%, #050816 100%);
      color: #1f2933;
      overflow: hidden;
    }

    .snow { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 0; }
    .snow span {
      position: absolute; top: -10px; width: 6px; height: 6px; border-radius: 50%;
      background: rgba(255,255,255,0.9); animation: fall linear infinite; opacity: .8;
    }
    @keyframes fall { 0% { transform: translateY(-10px); } 100% { transform: translateY(110vh); } }

    .card {
      position: relative; z-index: 2; background: rgba(255,255,255,0.96);
      border-radius: 24px; padding: 22px 18px; max-width: 420px; width: 100%;
      box-shadow: 0 18px 45px rgba(0,0,0,.4); backdrop-filter: blur(10px);
      border: 1px solid rgba(248,250,252,.95); animation: cardIn .45s ease-out;
    }
    @keyframes cardIn { from { opacity: 0; transform: translateY(20px) scale(.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

    .card::before {
      content: ""; position: absolute; inset: -2px; border-radius: 26px; padding: 1px;
      background: linear-gradient(135deg, rgba(239,68,68,.7), rgba(34,197,94,.7));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; opacity: .75; pointer-events: none;
    }

    .santa-mini {
      position: absolute; top: -30px; left: 50%; transform: translateX(-50%); font-size: 40px;
      z-index: 3; animation: danceSanta 1s infinite ease-in-out;
    }
    @keyframes danceSanta { 0% { transform: translateX(-50%) rotate(-10deg); } 50% { transform: translateX(-50%) rotate(10deg); } 100% { transform: translateX(-50%) rotate(-10deg); } }

    .reindeer {
      position: fixed; bottom: 18px; left: -60px; font-size: 34px; z-index: 1;
      animation: walkReindeer 14s linear infinite; opacity: .9;
    }
    @keyframes walkReindeer { 0% { transform: translateX(0); } 100% { transform: translateX(120vw); } }

    .badge { display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-size: .85rem;
      padding: 5px 14px; border-radius: 999px; background: linear-gradient(135deg,#b91c1c,#065f46);
      color: #fefce8; margin: 20px auto 12px;
    }

    h1 { font-size: 1.5rem; text-align: center; margin-bottom: 4px; color:#111827; }
    .tagline { font-size: .85rem; text-align:center; color:#6b7280; margin-bottom:4px; }
    .price { font-size: .95rem; text-align:center; font-weight:600; margin-bottom:10px; color:#b91c1c; }
    .place { font-size: .82rem; text-align:center; margin-bottom:16px; color:#374151; line-height:1.4; }
    .place a { color:#16a34a; font-weight:600; text-decoration:none; }
    .subtitle { font-size:.9rem; text-align:center; color:#4b5563; margin-bottom:14px; }

    label { font-size:.85rem; margin-bottom:6px; color:#111827; display:block; }
    select, button {
      width:100%; padding:12px 14px; border-radius:999px; font-size:1rem; outline:none;
    }
    select { background:#f9fafb; border:1px solid #e5e7eb; margin-bottom:14px; }
    button {
      background: linear-gradient(135deg,#b91c1c,#16a34a); color:white; border:none; font-weight:600; cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,.3); transition: transform .1s ease;
    }

    .result { display:none; margin-top:18px; padding:14px; border-radius:14px; background:#f1f5f9;
      border:1px dashed #9ca3af; font-size:.95rem; transform-origin:center;
    }
    .result.show { display:block; animation: resultPop .28s ease-out; }
    @keyframes resultPop { 0% { opacity:0; transform:scale(.9) translateY(6px); }
                           100%{ opacity:1; transform:scale(1) translateY(0); } }

    .error { margin-top:10px; font-size:.8rem; color:#b91c1c; text-align:center; }
    .note { font-size:.8rem; margin-top:12px; text-align:center; color:#6b7280; }
    .footer { font-size:.7rem; text-align:center; margin-top:18px; color:#9ca3af; }
    .creator { font-size:.7rem; text-align:center; margin-top:4px; color:#7f8c9d; }
  </style>
</head>

<body>
  <div class="snow" id="snow"></div>
  <div class="reindeer">ü¶å</div>

  <div class="card">
    <div class="santa-mini">üéÖ</div>
    <div class="badge">Intercambio Navide√±o 2025</div>

    <h1>Santa Secreto Familiar</h1>
    <p class="tagline">Familia Villa ¬∑ Unidos ¬∑ Tradici√≥n üéÅ</p>
    <p class="price">üí∞ Monto: <strong>$500 MXN</strong></p>

    <p class="place">
      üìç <strong>Casa de Sergio Villa</strong><br>
      Calle Guam√∫chil #52 ¬∑ Zapopan, Jalisco<br>
      üëâ <a href="https://maps.app.goo.gl/PkwVp3p2bp2CBwY8A" target="_blank">Ver mapa</a>
    </p>

    <p class="subtitle">Selecciona tu nombre para saber a qui√©n le vas a regalar.</p>

    <label for="nameSelect">¬øQui√©n eres?</label>
    <select id="nameSelect"><option value="">-- Selecciona tu nombre --</option></select>

    <button id="drawBtn">Ver a qui√©n le regalo üéÅ</button>
    <div id="result" class="result"></div>
    <div id="error" class="error"></div>

    <p class="note">üí° Solo ver√°s tu propio resultado. No recargues la p√°gina üòú</p>
    <p id="deviceNote" class="note" style="display:none;"></p>
    <div class="footer">Intercambio familiar ¬∑ 2025</div>
    <div class="creator">Creado por <strong>Paulo Cesar Villa Ibarra</strong></div>
  </div>

  <!-- ========================== -->
  <!-- üß© TU SCRIPT ORIGINAL      -->
  <!-- ========================== -->
  <script>
    const PARTICIPANTS = [
      "Paulo Cesar", "Naydelin Fernanda", "Sergio Villa", "Julia Ibarra",
      "Daniel Villa", "Oscar Padilla", "Mayra Villa", "Leonardo Mat√≠as",
      "Papa Chava", "Mama Tere", "Tania Villa", "Novio de Tania Diego",
      "Mayte Villa", "Marichuy", "Omar Junior", "Fernanda Qui√±ones",
      "Beto El que me regalara su carro", "Brayan", "Novia de Brayan Valentina",
      "Salvador Villa", "Irene Salazar"
    ];

    const params  = new URLSearchParams(window.location.search);
    const edition = params.get("edicion") || "1";
    const isAdmin = params.get("admin") === "paulo2025";

    const SEED = "intercambio-navideno-familiar-2025-edicion-" + edition;
    const STORAGE_KEY = "intercambio_navideno_2025_nombre_edicion_" + edition;

    function xmur3(str){
      let h = 1779033703 ^ str.length;
      for (let i = 0; i < str.length; i++) {
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      return function () {
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        h ^= h >>> 16;
        return h >>> 0;
      };
    }

    function mulberry32(a){
      return function () {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t = t ^ (t + Math.imul(t ^ (t >>> 7), t | 61));
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function seededShuffle(array, seedStr){
      const seedFn = xmur3(seedStr);
      const rng = mulberry32(seedFn());
      const a = array.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function generateDerangement(names, seedStr){
      for (let attempt = 0; attempt < 1000; attempt++) {
        const shuffled = seededShuffle(names, seedStr + "#" + attempt);
        if (shuffled.every((v,i)=>v !== names[i])) return shuffled;
      }
      throw new Error("No se pudo generar un sorteo v√°lido.");
    }

    let assignment = generateDerangement(PARTICIPANTS, SEED)
      .reduce((map, val, idx) => (map[PARTICIPANTS[idx]] = val, map), {});

    const nameSelect = document.getElementById("nameSelect");
    const drawBtn = document.getElementById("drawBtn");
    const resultBox = document.getElementById("result");
    const errorBox = document.getElementById("error");
    const deviceNote = document.getElementById("deviceNote");

    PARTICIPANTS.forEach(n=>{
      const op=document.createElement("option");
      op.value=n; op.textContent=n;
      nameSelect.appendChild(op);
    });

    let storedName = localStorage.getItem(STORAGE_KEY);
    if(storedName){ nameSelect.value = storedName; }

    drawBtn.addEventListener("click", ()=>{
      const selected = nameSelect.value;
      if(!selected){ errorBox.textContent="Selecciona tu nombre."; return; }
      localStorage.setItem(STORAGE_KEY, selected);

      resultBox.innerHTML = `
        üëã Hola <strong>${selected}</strong><br>
        Te toca regalarle a:<br>
        üéÅ <strong>${assignment[selected]}</strong>
        <br><br>
        <button onclick="marcarComoVisto('${selected}')">
          Entendido ‚úî
        </button>
      `;
      resultBox.classList.add("show");
    });
  </script>

  <!-- =================================== -->
  <!-- üî• SCRIPT FIREBASE (COMPLETITO)     -->
  <!-- =================================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBkln8OvQIhSd2Phnbt0VpUWxwlfiP5upo",
      authDomain: "intercambio-familiar-2025.firebaseapp.com",
      projectId: "intercambio-familiar-2025",
      storageBucket: "intercambio-familiar-2025.firebasestorage.app",
      messagingSenderId: "782877002512",
      appId: "1:782877002512:web:fa9e0fc96fa2fe2074f395"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const edicion = params.get("edicion") || "1";
    const admin = params.get("admin");

    const docRef = doc(db, "vistas", `edicion-${edicion}`);

    async function marcarComoVisto(nombre){
      const snap = await getDoc(docRef);
      if(!snap.exists()) await setDoc(docRef, { vistos: {} });

      await updateDoc(docRef, {
        [`vistos.${nombre}`]: true
      });

      alert("Marcado como visto ‚úî");
    }

    async function mostrarAdmin(){
      if(admin !== "paulo2025") return;

      const snap = await getDoc(docRef);
      const data = snap.data();

      const lista = data?.vistos
        ? Object.keys(data.vistos).map(n=>`‚Ä¢ ${n}`).join("<br>")
        : "<i>Nadie ha confirmado todav√≠a</i>";

      document.body.innerHTML += `
        <div style="
          position:fixed;top:10px;right:10px;background:#0f172a;
          color:#e5e7eb;padding:14px;border-radius:12px;z-index:9999;
          box-shadow:0 6px 20px rgba(0,0,0,.4);font-size:13px;max-width:260px;">
          <b>üëë Admin ‚Äì Edici√≥n ${edicion}</b><br><br>
          ${lista}
        </div>
      `;
    }

    mostrarAdmin();
    window.marcarComoVisto = marcarComoVisto;
  </script>

</body>
</html>
